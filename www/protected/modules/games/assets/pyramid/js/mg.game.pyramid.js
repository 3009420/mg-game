MG_GAME_PYRAMID = function ($) {
    return $.extend(MG_GAME_API, {
        wordField:null,
        playOnceMoveOnFinalScreenWaitingTime:15000, // milliseconds
        submitButton:null,
        media:null,
        licence_info:[],
        more_info:null,
        levels:[],
        level:1,
/*
*<span class="countdown_row countdown_show2">
*     <span class="countdown_section"><span class="countdown_amount">7</span><br></span>
*     <span class="countdown_section"><span class="countdown_amount">4</span><br></span></span>
 */
        /*
         * initialize the game. called from inline script generated by the view
         */
        init:function (options) {
            $('#countdown').countdown({until:'+2m', format:'MS', onExpiry:MG_GAME_PYRAMID.liftOff});
            var settings = $.extend(options, {
                ongameinit:MG_GAME_PYRAMID.ongameinit
            });
            $("#fieldholder").hide();

            MG_GAME_PYRAMID.wordField = $("#word");

            // submit on enter
            MG_GAME_PYRAMID.wordField.focus().keydown(function (event) {
                if (event.keyCode == 13) {
                    MG_GAME_PYRAMID.onsubmit();
                    return false;
                }
            });

            MG_GAME_PYRAMID.submitButton = $("#button-play").click(MG_GAME_PYRAMID.onsubmit);
            // Delete the default footer content.
            $("#footer").html("");
            MG_GAME_API.game_init(settings);
            $("#container").find("footer div").html("Level 1");
            /*$().toastmessage("showToast", {
                text:"Level 1",
                position:"middle-center",
                type:"notice"
            });*/
        },

        /*
         * display games turn
         */
        renderTurn:function (response) {
            $("#stage").hide();

            $("#image_container").html("");

            var turn_info = {
                url:response.turn.medias[0].full_size,
                url_full_size:response.turn.medias[0].full_size,
                licence_info:MG_GAME_API.parseLicenceInfo(response.turn.licences)
            };

            $("#template-turn").tmpl(turn_info).appendTo($("#image_container"));

            $("#image_to_tag").height($(window).height() - 32 - 60 - 70);


            $("#licences").html("");
            $("#template-licence").tmpl(MG_GAME_PYRAMID.licence_info).appendTo($("#licences"));

            $("#more_info").html("");

            if (MG_GAME_PYRAMID.more_info != null &&
                MG_GAME_PYRAMID.more_info.hasOwnProperty("url"))
                $("#template-more-info").tmpl(MG_GAME_PYRAMID.more_info).appendTo($("#more_info"));

            $("a[rel='zoom']").fancybox({overlayColor:'#000'});

            $("#stage").fadeIn(1000, function () {
                MG_GAME_PYRAMID.busy = false;
                MG_GAME_PYRAMID.wordField.focus();
            });
        },

        /*
         * display the final turn
         */
        renderFinal:function () {
            $("#stage").hide();

            $('#game_description').hide();

            $("#fieldholder").hide().html("");

            $("#input_area").html("");
            $("#input_area").hide();

            var final_info = {
                finalMsg:"You got to level " + MG_GAME_PYRAMID.level + " amazing!"
            }

            $("#template-final-info").tmpl(final_info).appendTo($("#fieldholder"));
            $("#fieldholder").show();
            $("#gamearea").hide();
            $("#content").find("header").hide();
            $("#content").find("footer").hide();

            var level_info = {
                tag:"",
                width:0
            }

            var fix = $("#fieldholder");
            for (var i in MG_GAME_PYRAMID.levels) {
                var level = MG_GAME_PYRAMID.levels[i];
                fix.find(".word_level_" + level.level).html(level.tag.tag);

                //level_info.width = 50 * level.level;
                //level_info.tag = level.tag.tag;
                //$("#template-pyramid-step").tmpl(level_info).appendTo($("#fieldholder"));
            }

            for (var i= MG_GAME_PYRAMID.level; i < 10; i++) {
                fix.find(".word_level_" + i).hide();
            }
            $("#licences").html("");
            $("#template-licence").tmpl(MG_GAME_PYRAMID.licence_info).appendTo($("#licences"));

            $("#more_info").html("");

            if (MG_GAME_PYRAMID.more_info != null && MG_GAME_PYRAMID.more_info.hasOwnProperty("url"))
                $("#template-more-info").tmpl(MG_GAME_PYRAMID.more_info).appendTo($("#more_info"));


            $("#image_container").html("");
            if (MG_GAME_PYRAMID.game.play_once_and_move_on == 1) {
                var info = {
                    remainingTime:null,
                    play_once_and_move_on_url:null
                };
                info.remainingTime = (MG_GAME_NEXTAG.playOnceMoveOnFinalScreenWaitingTime / 1000);
                info.play_once_and_move_on_url = MG_GAME_NEXTAG.game.play_once_and_move_on_url;

                $("#template-final-info-play-once").tmpl(info).appendTo($("#fieldholder"));
                $("#template-final-summary-play-once").tmpl(info).appendTo($("#image_container"));
                $("#box1").hide();
                window.setTimeout(function () {
                    window.location = info.play_once_and_move_on_url;
                }, MG_GAME_PYRAMID.playOnceMoveOnFinalScreenWaitingTime);

                var updateRemainingTime = function () {
                    MG_GAME_PYRAMID.playOnceMoveOnFinalScreenWaitingTime -= 1000;
                    if (MG_GAME_PYRAMID.playOnceMoveOnFinalScreenWaitingTime >= 1) {
                        $('#remainingTime').text(MG_GAME_PYRAMID.playOnceMoveOnFinalScreenWaitingTime / 1000);
                        window.setTimeout(updateRemainingTime, 1000);
                    }
                }
                window.setTimeout(updateRemainingTime, 1000);
            }

            $("#image_review img").height(($(window).height() - 30 - 89 - 100 - 40) / 2);

            $("a[rel='zoom']").fancybox({overlayColor:'#000'});

            MG_GAME_API.releaseOnBeforeUnload();

            $("#button-play-again").click(function() {
                location.reload();
            });

            $("#stage").fadeIn(1000, function () {
                MG_GAME_PYRAMID.busy = false;
                MG_GAME_PYRAMID.wordField.focus();
            });
        },

        /*
         * evaluate each response from /api/games/play calls (POST or GET)
         */
        onresponse:function (response) {
            MG_GAME_API.curtain.hide();

            if ($.trim(MG_GAME_PYRAMID.game.more_info_url) != "")
                MG_GAME_PYRAMID.more_info = {url:MG_GAME_PYRAMID.game.more_info_url, name:MG_GAME_PYRAMID.game.name};

            MG_GAME_PYRAMID.media = response.turn.medias[0]

            var accepted = {
                level:1,
                tag:""
            };

            var turn = response.turn;
            for (i_img in turn.tags.user) {
                var media = turn.tags.user[i_img];
                for (i_tag in media) {
                    // PASSING: If we find the passing tag, we just skip it.
                    if (i_tag == MG_GAME_PYRAMID.passStringFiltered) {
                        continue;
                    }
                    var tag = media[i_tag];

                    if (turn.medias[0].tag_accepted) {
                        accepted.level = turn.medias[0].level;
                        accepted.tag = tag;
                        MG_GAME_PYRAMID.levels.push(accepted);
                        MG_GAME_PYRAMID.nextlevel();
                    } else {
                        $().toastmessage("showToast", {
                            text:"No match! Try again",
                            position:"middle-center",
                            type:"notice"
                        });
                    }
                }
            }

            if (turn.licences.length) {
                for (licence in turn.licences) { // licences
                    var found = false;
                    for (l_index in MG_GAME_PYRAMID.licence_info) {
                        if (MG_GAME_PYRAMID.licence_info[l_index].id == turn.licences[licence].id) {
                            found = true;
                            break;
                        }
                    }

                    if (!found)
                        MG_GAME_PYRAMID.licence_info.push(turn.licences[licence]);
                }
            }
            MG_GAME_API.renderTurn(response);
        },


        /*
         * on callback for the submit button
         */
        onsubmit:function () {
            if (!MG_GAME_PYRAMID.busy) {
                var tags = $.trim(MG_GAME_PYRAMID.wordField.val());
                if (tags == "") {
                    $().toastmessage("showToast", {
                        text:"<h1>Ooops</h1><p>Please enter at least one word</p>",
                        position:"middle-center",
                        type:"notice"
                    });
                } else if (tags.length != (MG_GAME_PYRAMID.level + 2)) {
                    $().toastmessage("showToast", {
                        text:"That wasn't a " + (MG_GAME_PYRAMID.level + 2) + " letter word!",
                        position:"middle-center",
                        type:"notice"
                    });
                } else {
                    // text entered
                    MG_GAME_API.curtain.show();
                    MG_GAME_PYRAMID.busy = true;

                    // send ajax call as POST request to validate a turn
                    MG_API.ajaxCall('/games/play/gid/' + MG_GAME_API.settings.gid, function (response) {
                        if (MG_API.checkResponse(response)) {
                            MG_GAME_PYRAMID.wordField.val("");
                            MG_GAME_PYRAMID.onresponse(response);
                        }
                    }, {
                        type:'post',
                        data:{ // this is the data needed for the turn
                            turn:1,
                            played_game_id:MG_GAME_PYRAMID.game.played_game_id,
                            'submissions':[
                                {
                                    media_id:MG_GAME_PYRAMID.media.media_id,
                                    tags:tags
                                }
                            ]
                        }
                    });
                }
            }
            return false;
        },

        /*
         * this method appears to be not used
         */
        submit:function () {
            MG_API.ajaxCall('/games/play/gid/' + MG_GAME_API.settings.gid, function (response) {
                if (MG_API.checkResponse(response)) { // we have to check whether the API returned a HTTP Status 200 but still json.status == "error" response
                    MG_GAME_API.game = $.extend(MG_GAME_API.game, response.game);
                    MG_GAME_API.settings.ongameinit(response);
                }
            });
        },

        /*
         * process /api/games/play get request responses
         */
        ongameinit:function (response) {
            MG_GAME_PYRAMID.onresponse(response);
        },

        liftOff:function () {
            MG_GAME_PYRAMID.renderFinal();
        },

        nextlevel:function () {
            MG_GAME_PYRAMID.level++;
            MG_GAME_PYRAMID.wordField.attr("placeholder", "Enter a " + (MG_GAME_PYRAMID.level + 2) + " letter word");
            $("#container").find("footer div").html("Level " + MG_GAME_PYRAMID.level);
            $("#container").find("footer").css("background-image", "url(../images/level_" + MG_GAME_PYRAMID.level + ".png)");

            /*$().toastmessage("showToast", {
                text:"Level " + MG_GAME_PYRAMID.level,
                position:"middle-center",
                type:"success"
            });*/
        }
    });
}(jQuery);


/* For the new side panel */
$('#sidepanel #tab').toggle(function () {
    $(this).attr("class", "tab_open");
    $('#sidepanel').animate({'right':0});
}, function () {
    // Question: Why does '-290' work, and '-300' push the arrow too
    // far right?
    $(this).attr("class", "tab_closed");
    $('#sidepanel').animate({'right':-290});
});